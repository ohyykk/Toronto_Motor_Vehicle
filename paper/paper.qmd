---
title: "When Risk Hits the Road: Does Danger Drive a Return?"
subtitle: "Motor Theft and Collisions in Toronto Are Driven by [Neighborhood Clustering] and [Environmental Conditions]"
author: 
  - Yingke He
thanks: "Code and data are available at: [https://github.com/ohyykk/Toronto_Motor_Viehicle/tree/main](https://github.com/ohyykk/Toronto_Motor_Viehicle/tree/main)."
date: today
date-format: long
abstract: "This study examines motor vehicle theft and traffic collisions in Toronto, focusing on spatial and temporal patterns,and environmental factors. A composite risk score model is used and reveals that collisions occur more frequently under unfavorable road conditions, such as poor lighting and wet or icy surfaces, and in areas with inadequate traffic control measures. These findings emphasize the need for targeted interventions, including enhanced road infrastructure and lighting in collision-prone zones. Such measures aim to improve safety and security for motorbike riders and owners, contributing to safer urban mobility in Toronto."
format: pdf
toc: true
number-sections: true
bibliography: references.bib
---

```{r}
#| include: false
#| warning: false
#| message: false

library(tidyverse)
library(palmerpenguins)
library(knitr)

library(here)
library(car)


# Define file paths for data
theft_data_path <- here("data", "02-analysis_data", "cleaned_crime_data.csv")
traffic_data_path <- here("data", "02-analysis_data", "cleaned_traffic_data.csv")

```

```{r}
#| include: false
#| warning: false
#| message: false
#### Workspace Setup ####
library(tidyverse)
library(here)

# Load dataset
cleaned_crime_data <- read_csv(here("data", "02-analysis_data", "cleaned_crime_data.csv"))

#### Calculate Theft Sub-Indexes ####

# 1. Hour Index
hour_index <- cleaned_crime_data %>%
  count(hour) %>%
  mutate(
    proportion = n / sum(n),
    index = proportion / 3,  # Normalize so the sum equals 1/3
    type = as.character(hour)
  ) %>%
  select(type, index)

# 2. Day of Week Index
day_index <- cleaned_crime_data %>%
  count(day_of_week) %>%
  mutate(
    proportion = n / sum(n),
    index = proportion / 3,  # Normalize so the sum equals 1/3
    type = day_of_week
  ) %>%
  select(type, index)

# 3. Premises Type Index
premises_index <- cleaned_crime_data %>%
  count(premises_type) %>%
  mutate(
    proportion = n / sum(n),
    index = proportion / 3,  # Normalize so the sum equals 1/3
    type = premises_type
  ) %>%
  select(type, index)

# Combine all indexes into one table
theft_indexes <- bind_rows(
  hour_index,
  day_index,
  premises_index
)

#### Save as CSV ####
output_path <- here("data", "02-analysis_data", "theft_indexes.csv")
write_csv(theft_indexes, output_path)

#### Define the Theft Scoring Model ####
# Create a theft scoring model function
theft_scoring_model <- list(
  hour_index = hour_index,
  day_index = day_index,
  premises_index = premises_index,
  scoring_logic = function(hour, day_of_week, premises_type) {
    # Lookup values for indexes
    hour_score <- hour_index %>% filter(type == as.character(hour)) %>% pull(index)
    day_score <- day_index %>% filter(type == day_of_week) %>% pull(index)
    premises_score <- premises_index %>% filter(type == premises_type) %>% pull(index)
    
    # Calculate total theft risk score
    total_score <- sum(hour_score, day_score, premises_score, na.rm = TRUE)
    return(total_score)
  }
)

#### Save the Theft Scoring Model ####
rds_output_path <- here("models", "theft_scoring_model.rds")
saveRDS(theft_scoring_model, rds_output_path)

# Load datasets
cleaned_traffic_data <- read_csv(here("data", "02-analysis_data", "cleaned_traffic_data.csv"))

#### Preprocess Traffic Data ####
# Add a binned time-of-day variable
cleaned_traffic_data <- cleaned_traffic_data %>%
  mutate(
    time_of_day_bin = case_when(
      time_of_day >= 0 & time_of_day < 600 ~ "Late Night",
      time_of_day >= 600 & time_of_day < 1200 ~ "Morning",
      time_of_day >= 1200 & time_of_day < 1800 ~ "Afternoon",
      time_of_day >= 1800 & time_of_day <= 2359 ~ "Evening",
      TRUE ~ "Unknown"
    )
  )

# Preprocess severity as a binary variable
cleaned_traffic_data <- cleaned_traffic_data %>%
  mutate(
    severity = case_when(
      injury == "Major" | accident_classification == "Fatal" ~ 1,  # Severe cases
      injury %in% c("Minor", "Minimal") ~ 0,                       # Non-severe cases
      TRUE ~ NA_real_                                              # NA for missing or undefined
    )
  ) %>%
  filter(!is.na(severity))  # Remove rows where severity could not be determined



#### Logistic Regression Model for Collision Severity ####
collision_severity_model <- glm(
  formula = severity ~ hood_158 + time_of_day_bin + traffic_control +
    visibility_conditions + lighting_conditions + road_conditions,
  family = binomial(link = "logit"),
  data = cleaned_traffic_data
)

# Summarize the model
cat("Collision Severity Model Summary:\n")
summary(collision_severity_model)

#### Add Predicted Probabilities to Traffic Data ####
# Filter traffic data for consistent training and prediction
filtered_traffic_data <- cleaned_traffic_data %>%
  filter(!is.na(severity))  # Match rows used for training

# Debugging: Check sizes for consistency
cat("Rows in filtered data (used for model training): ", nrow(filtered_traffic_data), "\n")
cat("Rows in original traffic data: ", nrow(cleaned_traffic_data), "\n")

# Generate predictions for the filtered dataset
filtered_traffic_data <- filtered_traffic_data %>%
  mutate(
    collision_probability = predict(collision_severity_model, newdata = filtered_traffic_data, type = "response")
  )

# Merge predictions back into the original dataset
cleaned_traffic_data <- cleaned_traffic_data %>%
  left_join(
    filtered_traffic_data %>%
      select(id, collision_probability),  # Ensure unique identifier is used
    by = "id"
  )

# Debugging: Check for successful merging
cat("Rows in cleaned traffic data after merging predictions: ", nrow(cleaned_traffic_data), "\n")

#### Save Model and Results ####
# Save the logistic regression model
saveRDS(collision_severity_model, here("models", "collision_severity_model.rds"))



#### Model Diagnostics ####
# Correlation between predictors (optional)
cat("Correlation matrix of numeric predictors:\n")
correlation_matrix <- cleaned_traffic_data %>%
  select(time_of_day, fatal_no) %>%  # Replace with relevant numeric predictors
  cor(use = "complete.obs")
print(correlation_matrix)


#### Save Collision Risk Scores ####
# Select relevant columns to save
collision_risk_scores <- cleaned_traffic_data %>%
  select(id, hood_158, collision_probability)

# Define output path
collision_output_path <- here("data", "02-analysis_data", "collision_risk_scores.csv")

# Save as CSV
write_csv(collision_risk_scores, collision_output_path)



#### Load Data ####
# Load theft indexes
theft_indexes <- read_csv(here("data", "02-analysis_data", "theft_indexes.csv"))

# Load theft data
cleaned_crime_data <- read_csv(here("data", "02-analysis_data", "cleaned_crime_data.csv"))

# Load traffic data with collision probabilities
cleaned_traffic_data <- read_csv(here("data", "02-analysis_data", "cleaned_traffic_data.csv"))

#### Ensure Collision Probability ####
# If collision_probability is missing, calculate it
if (!"collision_probability" %in% colnames(cleaned_traffic_data)) {
  cleaned_traffic_data <- cleaned_traffic_data %>%
    mutate(
      time_of_day_bin = case_when(
        time_of_day >= 0 & time_of_day < 600 ~ "Late Night",
        time_of_day >= 600 & time_of_day < 1200 ~ "Morning",
        time_of_day >= 1200 & time_of_day < 1800 ~ "Afternoon",
        time_of_day >= 1800 & time_of_day <= 2359 ~ "Evening",
        TRUE ~ "Unknown"
      ),
      severity = case_when(
        injury == "Major" | accident_classification == "Fatal" ~ 1,
        injury %in% c("Minor", "Minimal") ~ 0,
        TRUE ~ NA_real_
      )
    ) %>%
    filter(!is.na(severity))
  
  collision_severity_model <- glm(
    formula = severity ~ hood_158 + time_of_day_bin + traffic_control +
      visibility_conditions + lighting_conditions + road_conditions,
    family = binomial(link = "logit"),
    data = cleaned_traffic_data
  )
  
  cleaned_traffic_data <- cleaned_traffic_data %>%
    mutate(
      collision_probability = predict(collision_severity_model, newdata = ., type = "response")
    )
}

#### Calculate Theft Component ####
# Aggregate theft indexes for simplicity
hour_index <- theft_indexes %>% filter(str_detect(type, "^\\d+$"))
day_index <- theft_indexes %>% filter(type %in% c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"))
premises_index <- theft_indexes %>% filter(type %in% c("House", "Outside", "Commercial"))

# Add indexes to the theft data
cleaned_crime_data <- cleaned_crime_data %>%
  mutate(
    hour = as.character(hour),  # Ensure hour is a character
    hour = if_else(hour == "24", "0", hour)  # Handle 24:00 case
  ) %>%
  left_join(hour_index, by = c("hour" = "type")) %>%
  rename(hour_index = index) %>%
  left_join(day_index, by = c("day_of_week" = "type")) %>%
  rename(day_index = index) %>%
  left_join(premises_index, by = c("premises_type" = "type")) %>%
  rename(premises_index = index) %>%
  mutate(
    theft_component = hour_index + day_index + premises_index  # Sum theft sub-indexes
  )

#### Add Theft Component to Traffic Data ####
# Add the average theft component by neighborhood
theft_by_neighborhood <- cleaned_crime_data %>%
  group_by(hood_158) %>%
  summarize(avg_theft_component = mean(theft_component, na.rm = TRUE))

cleaned_traffic_data <- cleaned_traffic_data %>%
  left_join(theft_by_neighborhood, by = "hood_158") %>%
  mutate(avg_theft_component = replace_na(avg_theft_component, 0))  # Replace NA with 0

#### Calculate Final Risk Index ####
# Define weights for components
weight_collision <- 0.7
weight_theft <- 0.3

# Calculate risk index
cleaned_traffic_data <- cleaned_traffic_data %>%
  mutate(
    risk_index = weight_collision * collision_probability + weight_theft * avg_theft_component
  )

#### Save Final Risk Index ####
# Save the final dataset with the risk index
output_path <- here("data", "02-analysis_data", "final_risk_index.csv")
write_csv(cleaned_traffic_data %>% select(id, hood_158, risk_index), output_path)

#### Save the Risk Calculation Model ####
# Define the final risk model
final_risk_model <- list(
  collision_model = collision_severity_model,
  theft_indexes = theft_indexes,
  weight_collision = weight_collision,
  weight_theft = weight_theft,
  risk_calculation_logic = function(collision_probability, avg_theft_component) {
    risk_index <- weight_collision * collision_probability + weight_theft * avg_theft_component
    return(risk_index)
  }
)

# Save the final risk model as RDS
rds_output_path <- here("models", "final_risk_model.rds")
saveRDS(final_risk_model, rds_output_path)



#### End of Script ####
```

# Introduction {#sec-intro}

Decisions surrounding motorbike ownership and usage carry significant implications for personal safety and financial liability. Recent statistics highlight the increased risks associated with owning and riding motorbikes, including a heightened likelihood of theft and collisions compared to other vehicles [@Yasmin2016]. These risks are influenced by various factors such as geographic location, road conditions, time of day, and type of motorbike, making it essential to develop tools that effectively assess and mitigate these dangers.\[can add one more sentence + citations\]

This study introduces a composite risk score model to assess the risks associated with owning and riding a motorbike. Using data from Open Data Toronto, the model evaluates two critical events: motorbike theft and collisions. Logistic regression is employed to estimate the probabilities of motor collisions, and a theft index is calculated which are then combined with the likelihood of motor collisions into a single, interpretable composite risk score. This metric is designed to guide motorbike users, insurers, and policymakers in risk assessment and decision-making, while informing strategies to mitigate these risks.

The primary estimand of the analysis is the composite risk score, derived from the individual probabilities of motorbike theft and collision. This score is calculated using predictor variables such as neighborhood characteristics, road and lighting conditions, time of day, and other contextual factors, which were selected for their documented relevance to motorbike-related risks.

This analysis confirms and extends three key findings: (1) theft risks vary based on temporal factors, such as time of day and day of the week, with mornings exhibiting higher susceptibility to theft, while early mornings have lower theft risks; (2) Collision risks are strongly influenced by environmental and situational conditions, with risks being particularly high under poor visibility. Factors such as wet or icy road surfaces and inadequate traffic controls further significantly increase the likelihood of incidents; and (3) neighborhood characteristics play a critical role in shaping both theft and collision risks, with high-collision-risk neighborhoods primarily clustered in high-traffic zones and a notable concentration of collision incidents in downtown Toronto, reflecting the impact of dense urban environments and heavy traffic flows on risk levels.

The structure of the paper is organized as follows: following @sec-intro, @sec-data outlines the data collection and preprocessing procedures, along with a detailed description of the outcome variable and the predictor variables used in the analysis. @sec-model introduces the logistic regression models applied to estimate the probability of collision, as well as the method used to derive the theft index and combine these probabilities into a composite risk score. @sec-result then presents the main findings, including insights into how different factors contribute to the risks of owning and riding a motorbike. Finally, @sec-discussion interprets the results, highlighting significant trends and implications for motorbike risk assessment, and concludes with a discussion on the limitations of the analysis and future research directions.

# Data {#sec-data}

We use the statistical programming language R [@citeR].... Our data [@shelter].... Following @tellingstories, we consider...

\[Libraries To be updated...\]

Details about the data cleaning process and the criteria for variable selection are provided in Appendix A.

## Source

This study utilized two datasets published by the Toronto Police Service, available from Open Data Toronto [@OpendataToronto]. The first dataset focuses on motor vehicle collisions involving killed or seriously injured persons (KSI), while the second examines thefts from motor vehicles.

The Motor Vehicle Collisions dataset includes all reported incidents in which a person was either killed or seriously injured since 2006. It offers detailed information about each collision, such as the type of incident, the severity of injuries, and the location of the event, when available. Additionally, the dataset includes fields for both the old 140 and new 158 neighborhood structures in Toronto, allowing for flexible neighborhood-level analysis across different definitions.

The Theft from Motor Vehicle dataset contains all reported occurrences of thefts from vehicles, categorized by reported date. These offences are classified based on the value of the stolen items, distinguishing between theft under and theft over thresholds. Each occurrence number may include multiple rows, representing the various offences associated with a single event. The dataset excludes "unfounded" occurrences, adhering to Statistics Canada’s definition that these events were determined not to have occurred or been attempted. Like the KSI dataset, this dataset includes fields for both the old and new neighborhood structures, enabling comprehensive geographic analyses of theft trends.

\[Add variable types and trends\]

## Data Measurement and Limitations

The process of translating real-world phenomena into entries in the dataset involves several stages. When a traffic collision or theft occurs, it is reported to law enforcement through various channels, such as emergency calls, online submissions, or in-person reports. Police officers or administrative personnel document the event details, including date, location, type of incident, and additional attributes such as severity or value of stolen items. These records are then digitized and aggregated into structured datasets, with fields organized to support analysis and reporting. However, during this process, certain changes or context-specific information may be lost, and the data ultimately reflects a structured summary of the events rather than their full complexity.

The datasets from Open Data Toronto did not specify the exact methods used for data collection, which may introduce some uncertainty regarding the consistency and reliability of the recorded events. Additionally, for privacy reasons, the locations of crime occurrences have been deliberately offset to the nearest road intersection node. This may result in discrepancies when analyzing counts by division or neighborhood, as the reported locations may not reflect the exact sites of the occurrences.

Some coordinate information in the datasets appears as “0, 0,” indicating that the specific location was either not validated or could not be geocoded. In such cases, a general division or neighborhood association may still be provided, but for invalid or external locations, the designation “NSA” (“Not Specified Area”) is used. Furthermore, the Toronto Police Service does not guarantee the accuracy, completeness, or timeliness of the data, which may lead to potential misinterpretations or incomplete analyses.

Additional details about the dataset are available in the datasheet, accessible through the repository linked to this paper.

## Outcome Variables

The outcome variable of this analysis is the Risk Index, a composite metric that integrates the probabilities of two underlying events: theft and collision.The Risk Index integrates two underlying components: the theft component, derived from proportional sub-indexes for temporal and spatial factors, and the collision probability, estimated using a logistic regression model. By combining these elements, the Risk Index provides a unified measure of risk, enabling the identification of high-risk scenarios and areas. 

```{r}
#| label: fig-risk-index-histogram
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "Distribution of the Overall Risk Index"
#| fig-pos: H
#| fig-width: 8 
#| fig-height: 4 

# Load necessary libraries
library(tidyverse)
library(here)

# Load the final Risk Index dataset
final_risk_index <- read_csv(here("data", "02-analysis_data", "final_risk_index.csv"))

# Plot a histogram with density overlay
ggplot(final_risk_index, aes(x = risk_index)) +
  geom_histogram(aes(y = ..density..), bins = 40, fill = "darkgrey", alpha = 0.6, color = "black") +
  geom_density(color = "darkred", size = 1) +
  labs(
    
    x = "Risk Index",
    y = "Density"
  ) +
  theme_minimal()

```

@fig-risk-index-histogram shows the distribution of the Risk Index across all observations in the dataset. The Risk Index shows a unimodal distribution, skewed slightly to the left, with the majority of values concentrated between 0.45 and 0.65. This indicates that most motorbike-related risks fall within a moderate range. The density curve overlay reveals a smooth progression in risk levels, with the peak occurring around a Risk Index value of 0.55, suggesting that this is the most common level of composite risk. The left tail, representing lower risk levels, is relatively small, while the right tail, corresponding to higher risks, extends further, indicating the presence of a smaller number of high-risk cases.

The skewness and spread of the distribution highlight the variability in the combined risks of theft and collision. The extended tail on the higher end of the Risk Index suggests that certain environmental or situational factors disproportionately increase the risks in specific cases. This insight can inform targeted interventions, focusing on the outliers with high Risk Index values to mitigate the most critical risks.


```{r}
#| label: fig-risk-index-boxplot
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "Risk Index Distribution by Risk Category"
#| fig-pos: H

library(ggplot2)
library(dplyr)

risk_index_data <- read_csv(here("data", "02-analysis_data", "final_risk_index.csv"))

# Assume `risk_index_data` contains the `risk_index` values for each neighborhood
# Group neighborhoods by average Risk Index
grouped_data <- risk_index_data %>%
  group_by(hood_158) %>%
  summarize(avg_risk_index = mean(risk_index, na.rm = TRUE)) %>%
  mutate(risk_category = case_when(
    avg_risk_index <= quantile(avg_risk_index, 0.25) ~ "Low Risk",
    avg_risk_index > quantile(avg_risk_index, 0.25) & avg_risk_index <= quantile(avg_risk_index, 0.75) ~ "Moderate Risk",
    avg_risk_index > quantile(avg_risk_index, 0.75) ~ "High Risk"
  ))

# Add risk categories directly to the `risk_index_data`
risk_index_data <- risk_index_data %>%
  left_join(grouped_data %>% select(hood_158, risk_category), by = "hood_158")

# Box plot of Risk Index by Risk Category with custom colors
ggplot(risk_index_data, aes(x = risk_category, y = risk_index, fill = risk_category)) +
  geom_boxplot(outlier.color = "darkred", outlier.shape = 16, alpha = 0.7) +
  scale_fill_manual(
    values = c("Low Risk" = "#603601", "Moderate Risk" = "#3a6a91", "High Risk" = "#cfb886")
  ) +
  labs(
    x = "Risk Category",
    y = "Risk Index"
  ) +
  theme_minimal() +
  theme(legend.position = "none")

```

Building on the distribution of the Risk Index in @fig-risk-index-histogram, @fig-risk-index-boxplot highlights the distribution of the Risk Index across three defined categories: High Risk, Low Risk and Moderate Risk. Each category represents a grouping of neighborhoods based on their average Risk Index values. The plot reveals distinct differences in the distribution of the Risk Index between these categories.

The High Risk category illustrates a higher median Risk Index, with a relatively narrow interquartile range (IQR), indicating consistent high-risk values across neighborhoods in this group. Conversely, the Low Risk category has a significantly lower median, with a similarly narrow IQR, suggesting stable low-risk conditions in these neighborhoods. The Moderate Risk category shows greater variability in its distribution, with a wider IQR and overlapping values with both High Risk and Low Risk categories. This suggests that neighborhoods in the Moderate Risk group exhibit diverse risk profiles, likely influenced by varying environmental and situational factors.

## Predictor Variables

The predictor variables in this study are organized into two distinct models: Theft Index and Collision Probability, each designed to capture and explain critical aspects of theft and collision risks, respectively. @fig-tree provide a visual overview of the hierarchical relationships between the predictor variables and the overall risk framework, offering a structured understanding of the factors contributing to these incidents

```{r}
#| label: fig-tree
#| fig-cap: "Hierarchical relationship between risk factors contributing to theft and collision probabilities."
#| echo: false
#| warning: false
#| message: false
#| fig-width: 8 # Increased width for better text display
#| fig-height: 4  # Adjusted height for spacing

# Load required libraries
library(tidygraph)
library(ggraph)

# Define the tree structure as a dataframe
tree_data <- data.frame(
  from = c("Risk Index", "Risk Index", "Theft Index", "Theft Index", "Theft Index",
           "Collision Probability", "Collision Probability", "Collision Probability", 
           "Collision Probability", "Collision Probability", "Collision Probability"),
  to = c("Theft Index", "Collision Probability", "Hour of the Day", "Day of the Week", 
         "Premises Type", "Neighborhood ID", "Road Surface Condition", 
         "Lighting Condition", "Traffic Control", "Time of Day", "Road Visibility")
)

# Convert to graph object
tree_graph <- as_tbl_graph(tree_data)

# Plot the tree diagram with horizontal layout and curved lines
ggraph(tree_graph, layout = "dendrogram", circular = FALSE) +
  geom_edge_bend(color = "gray", curvature = 0.5, arrow = arrow(length = unit(4, "mm")), end_cap = circle(4, "mm")) +
  geom_node_point(size = 6, color = "grey") +
  geom_node_text(
    aes(label = name, hjust = ifelse(name == "Risk Index", 1.3, -0.2)), # Conditional hjust
    vjust = -0.5, size = 4, color = "black", angle = 0
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  ) +
  coord_flip()

```

### Theft index

The Theft Index focuses on the temporal and locational characteristics that influence theft occurrences. By incorporating variables such as Hour of the Day, Day of the Week, and Premises Type, this model identifies patterns tied to specific times and locations, highlighting when and where thefts are most likely to occur.

#### Hour of the Day

The **Hour of the Day** variable is used as a predictor to analyze temporal trends in motorbike theft occurrences. This variable helps identify whether certain hours are associated with elevated or reduced theft risks. Contributing factors may include decreased monitoring during nighttime hours, increased activity in high-risk areas during specific times, or patterns related to commuter schedules. @plt-hour_summary outlines the distribution of theft incidents across different hours, offering insights into periods with disproportionately high or low occurrences, which could impact the understanding of temporal theft risk dynamics.

[plot of distribution of theft incidents across different hours]

#### Day of the Week

The **Day of the Week** variable is included as a predictor to examine weekly patterns in motorbike theft incidents. This variable helps determine whether theft risks vary across different days of the week. Factors such as increased activity on weekends, reduced monitoring during certain weekdays, or patterns linked to routine schedules may influence these variations. @plot-day_summary summarizes the distribution of theft incidents by day of the week, highlighting any days with notably high or low occurrences. 

[plot of distribution of theft incidents across day of week]

#### Premises Type

The **Premises Type** variable serves as a predictor to analyze the contextual settings where motorbike theft incidents occur. This variable helps identify whether certain types of premises, such as residential areas, commercial establishments, or public parking lots, are associated with higher or lower theft risks. Factors like the availability of surveillance, the density of parked motorbikes, or accessibility to offenders may contribute to variations across premises types. @tbl-premises_summary provides a breakdown of the number of theft incidents by premises type, highlighting locations with elevated or reduced risks. 

[table counting the number of theft incident happened in different premises eg house]

### Collision Probability

The Collision Probability model, on the other hand, examines situational and environmental conditions affecting the likelihood of collisions. Variables such as Neighborhood ID, Road Surface Condition, Lighting Condition, Traffic Control, Time of Day, and Visibility offer insights into the contextual factors that contribute to traffic incidents, capturing the dynamic interaction between environmental factors and human behavior.

#### Neighborhood ID

The **Neighborhood ID** variable is a categorical predictor that represents unique identifiers for neighborhoods in the City of Toronto. This variable captures spatial variations in motorbike theft and collision risks, enabling the analysis to identify neighborhood-specific patterns and trends. @tbl-neighborhood_summary provides a list of example Neighborhood IDs, illustrating how this variable is used to represent different areas in the dataset. This summary helps contextualize the role of neighborhoods in understanding collision risk distributions.

[table of some examples of neighborhood ID]

#### Road Surface Condition

The **Road Surface Condition** variable is a categorical predictor that describes the state of the road at the time of an incident, such as dry, wet, ice, or loose snow. This variable helps analyze how varying surface conditions influence motorbike collision risks.  @plot-road_surface_summary illustrates the number of incidents across various road surface conditions, [offering insights into how different surface types contribute to overall risk patterns.]

[barlot displaying the count of incidents across different road surface conditions]

#### Lighting Condition

The **Lighting Condition** variable is a categorical predictor that represents the type of lighting at the time of an incident, including conditions such as daylight, darkness, artificial lighting, or dawn. This variable is crucial for assessing how visibility levels and lighting environments influence the likelihood of motorbike thefts and collisions. Low visibility conditions, such as darkness or poor artificial lighting, are often linked to increased risks. @plt-lighting_summary shows the number of collision incident occurs for each lighting condition, where [xxx] has a highest...

[barplot displaying the count of incidents for different lighting conditions]

#### Traffic Control

The Traffic Control variable categorizes the type of traffic management present at the location of each incident. This includes classifications such as "No Control" and "Traffic Signal." These categories allow for an analysis of how different traffic control measures correlate with collision risks. Contributing factors may include the absence of control mechanisms leading to higher collision probabilities or the efficiency of traffic signals in mitigating such risks.

@tbl-traffic_control_summary highlights the number of incidents across various traffic control types, providing insights into which systems are most associated with increased or decreased collision risks.

[table for counting the number of collision for different traffic control]

#### Time of Day

The **Time of Day** variable captures the specific hour and minute when a collision occurred, represented in a 24-hour format. For instance, "2210" corresponds to 10:10 PM, while "315" indicates 3:15 AM. This variable enables a detailed analysis of temporal patterns in collision risks, helping to identify whether certain times of the day are associated with higher or lower probabilities of incidents.

Contributing factors may include reduced visibility during nighttime hours, increased traffic density during peak commuting periods, or varying driver behaviors at different times. @tbl-time_of_day_summary provides examples of time data, offering a comprehensive view of how collision occurrences are distributed throughout the day. Understanding these temporal trends can inform targeted interventions to enhance road safety during high-risk periods.

[table- 5 examples of different time of day]

#### Visibility



# Model {#sec-model}

The main purpose of this composite risk score model is to calculate a Risk Index for owning and riding a motorbike, which integrates the risks of theft and collisions. The modeling strategy has two primary objectives. The first objective is to estimate the likelihood of collisions under various environmental and situational conditions using a logistic regression model. The second objective is to derive a theft risk score based on time of day, day of the week, and premises type, combining these components into a unified Risk Index to provide actionable insights into motorbike-related risks. The models were developed in R [@citeR] using the `stats` package for logistic regression and the `tidyverse` package for data preprocessing and manipulation. The theft model calculates sub-indexes for specific predictors, while the collision model uses logistic regression to estimate probabilities based on predictors such as neighborhood ID, road surface condition, lighting condition, and traffic control. Both models are designed to enable reliable predictions under diverse conditions and are integrated into the final Risk Index, which highlights areas, times, and conditions with elevated risks.

Detailed model diagnostics, variable descriptions, and performance metrics are included in [Appendix @sec-model-details].

## Model Set-Up

### Theft Risk Sub-Indexes

To capture theft risk without relying on logistic regression due to the absence of negative (non-theft) cases, we calculated sub-indexes for three critical factors:

-Hour of the Day: Risk distribution across 24 hours, normalized so the sum equals 1/3.

-Day of the Week: Risk distribution across 7 days, normalized so the sum equals 1/3.

-Premises Type: Risk distribution across premises types (House, Outside, Commercial), normalized so the sum equals 1/3.

The total theft component is calculated as: \begin{align*}
C_{\text{Theft}} &= \text{Hour Index} + \text{Day Index} + \text{Premises Type Index}
\end{align*}

This approach ensures proportional representation of each factor while accounting for varying risks based on time and location characteristics.

### Collision Probability Model

A logistic regression model was used to predict the likelihood of severe collisions P(Collision) based on several predictors. The log-odds of the collision probability are modeled as:  

```{=tex}
\begin{align*}
\log\left(\frac{P(\text{Collision})}{1 - P(\text{Collision})}\right) &= \beta_0 + \beta_1 \cdot \text{HOOD}_{158} + \beta_2 \cdot \text{Road Surface Condition} + \beta_3 \cdot \text{Lighting Condition} \\
&\quad + \beta_4 \cdot \text{Traffic Control} + \beta_5 \cdot \text{Road Visibility} + \beta_6 \cdot \text{Time of Day} + \epsilon
\end{align*}
```
The model prediction utilizes the following predictor variables:

-   Neighborhood ID (`hood_158`): Unique identifier for the neighborhood.
-   Road Surface Condition (`road_conditions`): Conditions such as dry, wet, or icy.
-   Lighting Condition (`lighting_conditions`): Visibility levels, such as daylight or artificial light.
-   Traffic Control (`traffic_control`): Presence of traffic management devices (e.g., stop signs, signals).
-   Road Visibility (`visibility_conditions`): Road visibility conditions, such as clear, snow or rain
-   Time of Day (`time`): Time where collision occured in Toronto

The model assigns coefficients as follows:

```{=tex}
\begin{align*}
\beta_i \text{ to each variable, enabling the calculation of collision probability }\\ 
P(\text{Collision})\text{ under specific environmental and situational conditions.} 
\end{align*}
```
### Risk Index Calculation

The final Risk Index integrates the collision probability P(Collision) and theft component T using weighted aggregation:

```{=tex}
\begin{align*}
\text{Risk Index} = w_1\cdot P(\text{Collision}) + w_2\cdot T
\end{align*}
```
Weights are defined as: \begin{align*}
w_1 = 0.7, \quad w_2 = 0.3
\end{align*} These reflect the relative importance of collision and theft risks, emphasizing collision severity due to its greater immediate impact.

## Model Justification

The analysis adopts a hybrid approach that combines sub-index calculations for theft risk with logistic regression for collision probability. This design ensures that the model reflects the specific data characteristics and practical considerations when assessing motorbike-related risks. Logistic regression is not utilized for theft risk due to the absence of negative (non-theft) cases in the dataset. Instead, theft risk is represented through sub-index calculations for three critical factors: hour of the day, day of the week, and premises type. Each factor contributes equally to the total theft component. The Hour of the Day Index captures temporal variations in theft risk across 24 hours, while the Day of the Week Index accounts for weekly patterns of theft. The Premises Type Index reflects variations in risk based on location type, such as houses, outdoor spaces, or commercial premises. These sub-indexes are normalized so their contributions to the theft component are proportional and balanced. This approach ensures an accurate representation of theft risk patterns while providing actionable insights into temporal and spatial risk factors.

For collision risk, the model utilizes logistic regression due to its effectiveness in estimating probabilities for binary outcomes. The log-odds of collision probability are modeled as a function of neighborhood-specific characteristics, road surface conditions, lighting conditions, and traffic control measures. By including these predictors, the model accounts for diverse factors that influence collision risks. Logistic regression’s ability to handle both categorical and continuous variables makes it an appropriate choice for this component, delivering statistically reliable estimates and facilitating the interpretation of individual predictors’ effects.

The final Risk Index integrates the theft and collision components using a weighted formula. The collision probability component is weighted at 0.7, reflecting its higher immediate impact on safety, while the theft component is weighted at 0.3. This weighting scheme prioritizes collision risk while ensuring that theft risk is not overlooked. By combining these components, the Risk Index provides a unified measure of motorbike-related risks, enabling stakeholders to assess and compare safety conditions across different contexts.

This modeling approach is justified by its ability to adapt to the data’s constraints while maintaining statistical rigor and interpretability. The sub-index method for theft risk is tailored to the dataset’s characteristics, avoiding assumptions about unobserved cases, and the use of logistic regression for collision risk ensures robust and reliable predictions. Together, these components form a comprehensive and practical framework for evaluating motorbike ownership and usage risks, addressing both immediate safety concerns and long-term theft risks.

## Model Assumptions and Validations

### Theft Sub-Index \[add one sentence of validation\]

The theft sub-index approach is based on two key assumptions. First, it assumes that the observed proportions of theft occurrences across categories, such as hour of the day, day of the week, and premises type, accurately represent the overall theft risk. Second, it assumes that these categories contribute independently to the theft risk, meaning the risk associated with one category does not influence or depend on another.

### Composite Risk Index \[Add one sentence of assumption\]

The validation of the composite Risk Index involves two key steps. First, its correlation with observed collision severity will be tested to ensure alignment with real-world risks. Second, a sensitivity analysis will be conducted by testing alternate weightings for the collision and theft components $w_1$ and $w_2$ to evaluate the robustness and reliability of the final Risk Index.

### Collision Model

The logistic regression model for collision severity relies on several assumptions. First, the response variable (`severity`) is binary (1 = severe, 0 = non-severe), fulfilling the requirement for a binary outcome. Second, the data consist of independently reported collision incidents, ensuring that observations are uncorrelated. Third, the log-odds of collision severity are modeled as a linear combination of predictor variables; although most predictors are categorical, their contributions to the log-odds inherently satisfy this linearity assumption. Finally, to address the assumption of no multicollinearity, Variance Inflation Factor (VIF) will be calculated for all predictors. Predictors with high VIF values will be mitigated through re-categorization or removal to ensure stable and reliable coefficient estimates.

#### Binary Nature of the Outcome

A fundamental assumption of logistic regression is that the response variable is binary or dichotomous, meaning it can take on only two possible outcomes [@nick2007logistic]. This assumption is satisfied in the collision model, where the response variable (`severity`) distinguishes between severe (1) and non-severe (0) collision cases.

In the theft dataset, however, all entries represent theft cases, precluding the binary nature required for logistic regression. Consequently, the theft model was adapted to calculate proportion-based sub-indexes rather than relying on a binary outcome. These sub-indexes represent relative risk based on temporal and spatial factors, such as hour of the day, day of the week, and premises type.

In the collision model: - The model estimates the probability of a severe collision ((P(\text{Collision}))) given environmental and situational predictors. The response variable (`severity`) is defined as: \begin{align*}
  P(\text{Collision}) = \frac{\exp(\beta_0 + \beta_1 X_1 + \beta_2 X_2 + \cdots + \beta_k X_k)}{1 + \exp(\beta_0 + \beta_1 X_1 + \beta_2 X_2 + \cdots + \beta_k X_k)}
  \end{align*} where: \begin{align*}
  \beta_0 &\text{ is the intercept,} \\
  \beta_k &\text{ are the coefficients, and} \\
  X_k &\text{ are the predictor variables.}
  \end{align*}

The logistic regression model does not directly predict 1 or 0. Instead, it provides a continuous probability ranging between 0 and 1. This probability reflects the likelihood of an event (e.g., a severe collision) occurring under the given conditions.

#### Independence of Observations

The collision model assumes that each observation is independent of the others, a fundamental requirement for logistic regression. This assumption is satisfied in the dataset, as each row represents a distinct and independently reported collision incident. The observations are not repeated or correlated, ensuring that the logistic regression model provides unbiased estimates of the relationships between predictor variables and the response variable. By meeting this assumption, the collision model maintains its validity for estimating probabilities of severe collisions and contributes robustly to the composite Risk Index.

#### Linear Relationship in the Log-Odds

One of the key assumptions in logistic regression is that a linear relationship exists between the continuous predictors and the logit of the outcome variable [@stoltzfus2011]. This means that the log-odds of the binary dependent variable should have a linear association with any continuous independent variables in the model. It is important to test this assumption to ensure the validity of the model.

The collision risk logistic regression model incorporates both categorical and continuous predictor variables. Among these, Time of Day serves as the sole continuous predictor, representing the time an incident occurred as a numerical value ranging from 0 (midnight) to 2359 (just before midnight). The analysis emphasizes the continuous predictor, Time of Day, to evaluate its role within the collision model.

Linearity is assessed using smoothed scatter plots of the predicted logit values:

```{=tex}
\begin{align*}
\text{logit} = \log\left(\frac{P}{1 - P}\right)
\end{align*}
```
where P represents the predicted probability of collision from the logistic regression model plotted against the continuous predictors. These plots are intended to visualize the relationship between each predictor and the logit of the outcome variable, providing insight into whether the relationship is approximately linear.

```{r}
#| label: fig-linear-time-of-day
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "Logit Plot for Time of Day in the Collision Probability Model"
#| fig-pos: H
#| fig-width: 8
#| fig-height: 3.5

# Load necessary libraries
library(tidyverse)
library(ggplot2)
library(here)

# Use here() to construct file paths and then load the data into data frames
collision_data <- read_csv(here("data", "02-analysis_data", "collision_risk_scores.csv"))
cleaned_traffic_data <- read_csv(here("data", "02-analysis_data", "cleaned_traffic_data.csv"))

# Merge collision data with time_of_day from cleaned traffic data
collision_data <- collision_data %>%
  left_join(cleaned_traffic_data %>% select(id, time_of_day), by = "id") %>%
  mutate(
    collision_probability = ifelse(collision_probability <= 0, 0.0001, collision_probability),
    collision_probability = ifelse(collision_probability >= 1, 0.9999, collision_probability),
    logit = log(collision_probability / (1 - collision_probability))  # Logit transformation
  )

# Smoothed scatter plot for time_of_day vs logit
ggplot(collision_data, aes(x = time_of_day, y = logit)) +
  geom_point(alpha = 0.5, color = "darkgrey") +
  geom_smooth(method = "loess", color = "darkred", fill = "lightblue") +
  coord_cartesian(ylim = c(-5, 5)) +  # Restrict the y-axis range
  labs(
    x = "Time of Day",
    y = "Logit"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 14, face = "bold")  # Center title and adjust size
  )


```

Figure @fig-linear-time-of-day illustrates the relationship between variable Time of Day and the predicted values of the collision probability model. The horizontal axis represents the reported time of day in minutes since midnight, while the vertical axis displays the logit values. Gray points depict the raw data, and the blue smoothed line represents the average trend. To evaluate the linearity assumption, the smoothed line is compared to a hypothetical linear relationship. Significant deviations of the smoothed line from a straight line may suggest a potential violation of the linearity assumption.

In this plot, the smoothed line shows a relatively stable trend with minimal deviations, indicating no substantial evidence against the linearity assumption. Local fluctuations are minor and likely reflect natural variations in the data rather than a systematic departure from linearity.

#### Absence of Multicollinearity

Another key assumption of logistic regression is the absence of multicollinearity among predictor variables. Multicollinearity occurs when two or more predictors are highly correlated, leading to inflated standard errors of the regression coefficients and reducing the reliability of the model's estimates. The Variance Inflation Factor (VIF) is commonly used to assess multicollinearity, with VIF values greater than 5 indicating potential issues, and values above 10 suggesting severe multicollinearity [@stoltzfus2011].

In the collision risk model, the predictors include both categorical variables (Lighting Conditions, Road Conditions, Visibility Conditions and Traffic Control) and one continuous variable (Time of Day). VIF calculations are performed to evaluate the degree of multicollinearity among these predictors.

If multicollinearity is detected, strategies such as combining correlated variables, removing redundant predictors, or using regularization techniques like ridge regression can be employed [@stoltzfus2011]. However, if VIF values remain below the threshold, it confirms that multicollinearity is not a concern in this analysis.

The following table presents the VIF values for all predictors in the collision risk model.

```{r}
#| label: tbl-vif
#| echo: false
#| warning: false
#| message: false
#| tbl-cap: "VIF values for predictor variables in the collision model."
#| tbl-pos: H
library(performance)



# Run check_collinearity on the collision model
vif_result <- check_collinearity(collision_severity_model)

# Convert results to a data frame
vif_df <- as.data.frame(vif_result)

# Create a data frame with GVIF values
gvif_data <- data.frame(VIF = round(vif_df$VIF, 2))

# Convert the data frame into a kable table
vif_table <- kable(
  t(gvif_data), # transpose
  col.names = c("hood id", "time of day", "traffic control", "visibility", "lighting condition", "road condition"),
  escape = FALSE,
  align = "ccccc"
)

vif_table


```

The results of the VIF analysis for the collision risk model are presented in Table @tbl-vif. Most predictors exhibit VIF values well below the commonly used threshold of 5, indicating no significant multicollinearity among them. However, two predictors, Visibility Conditions and Road conditions, show slightly elevated VIF values of 7.29 and 7.51, respectively. While these values are higher than the others, they remain below the severe multicollinearity threshold of 10, suggesting that multicollinearity, though present to some extent, is not critical.

The slightly elevated VIF values can be attributed to a potential overlap in the information captured by Visibility Conditions and Road Conditions. For instance, poor visibility often coincides with adverse road conditions, such as wet or icy surfaces, leading to some degree of correlation between these variables.

Despite this overlap, both predictors are retained in the model because they provide distinct and meaningful contributions to understanding collision risk. Visibility Conditions directly reflects environmental factors like fog, heavy rain, or low light, which impair drivers' ability to see hazards. Conversely, Road Conditions\` account for the physical state of the driving surface, such as wet, icy, or damaged roads, which influence vehicle handling and stopping distance. Together, these variables capture complementary aspects of collision risk, ensuring that the model provides a comprehensive assessment.

The inclusion of both variables aligns with the theoretical framework underpinning the model and enhances its practical utility by addressing multiple dimensions of risk. While some degree of multicollinearity is observed, its impact on model stability is minimal, and the predictors' theoretical importance justifies their inclusion.

# Results {#sec-result}

## When Risk Peaks: Temporal Trends in the Index

### Time-of-Day Analysis

```{r}
#| label: fig-risk-index-timeofday
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "Risk Index by Time of Day, with bars showing Overall Risk Index, the red line showing Collision Risk, and green dots showing Theft Risk."
#| fig-pos: H
#| fig-width: 8
#| fig-height: 4

# Load necessary data
final_risk_data <- read_csv(here("data", "02-analysis_data", "final_risk_index.csv"))

cleaned_traffic_data <- read_csv(here("data", "02-analysis_data", "cleaned_traffic_data.csv"))

collision_risk_scores <- read_csv(here("data", "02-analysis_data", "collision_risk_scores.csv"))

# Convert 'id' to character in both datasets if necessary
final_risk_data$id <- as.character(final_risk_data$id)
cleaned_traffic_data$id <- as.character(cleaned_traffic_data$id)
collision_risk_scores$id <- as.character(collision_risk_scores$id)

# Merge the final risk index with the traffic data based on 'id'
merged_data <- left_join(final_risk_data, cleaned_traffic_data, by = "id")

# Merge the collision risk scores into the merged data
merged_data <- left_join(merged_data, collision_risk_scores, by = "id")

# Create 'time_of_day_bin' based on 'time_of_day' in cleaned_traffic_data
merged_data$time_of_day_bin <- case_when(
  merged_data$time_of_day >= 0 & merged_data$time_of_day < 600 ~ "Early Morning",
  merged_data$time_of_day >= 600 & merged_data$time_of_day < 1200 ~ "Morning",
  merged_data$time_of_day >= 1200 & merged_data$time_of_day < 1800 ~ "Afternoon",
  merged_data$time_of_day >= 1800 & merged_data$time_of_day < 2400 ~ "Evening"
)

# Group by 'time_of_day_bin' and calculate average values for risk index and collision index
summary_data <- merged_data %>%
  group_by(time_of_day_bin) %>%
  summarize(
    avg_risk_index = mean(risk_index, na.rm = TRUE),
    avg_collision_index = mean(collision_probability
, na.rm = TRUE)
  )

# Theft hour indexes (24-hour data points)
theft_hour_indexes <- c(0.005335554, 0.003690682, 0.002343943, 0.002158895, 0.001572909,
                        0.002415906, 0.006353319, 0.012295419, 0.018587055, 0.02577309,
                        0.026174027, 0.025526359, 0.025248787, 0.024107657, 0.021969323,
                        0.020334731, 0.018196398, 0.016448721, 0.016479562, 0.015400115,
                        0.013806645, 0.01254215, 0.009211284, 0.007360803)

# Create a mapping of the theft hour indexes to the time of day bins
theft_hour_bins <- c("Early Morning", "Early Morning", "Early Morning", "Early Morning", "Early Morning", 
                     "Morning", "Morning", "Morning", "Morning", "Morning", 
                     "Morning", "Morning", "Morning", "Afternoon", "Afternoon", 
                     "Afternoon", "Afternoon", "Afternoon", "Afternoon", 
                     "Evening", "Evening", "Evening", "Evening", "Evening")

# Create a dataframe for the theft data, with time_of_day_bin mapped accordingly
theft_hour_data <- data.frame(
  time_of_day_bin = theft_hour_bins,
  theft_index = theft_hour_indexes
)

# Summarize theft data by time_of_day_bin to match the bin structure used in the plot
theft_summary_data <- theft_hour_data %>%
  group_by(time_of_day_bin) %>%
  summarize(avg_theft_index = mean(theft_index))

# Merge with existing summary data for risk and collision indexes
final_plot_data <- left_join(summary_data, theft_summary_data, by = "time_of_day_bin")

# Plot: Risk Index, Collision Index, and Theft Hour Index by Time of Day Bin
ggplot(final_plot_data, aes(x = time_of_day_bin)) +
  geom_bar(aes(y = avg_risk_index), stat = "identity", fill = "#967145") +
  geom_line(aes(y = avg_collision_index), group = 1, color = "darkred", size = 1) + # Collision index line
  geom_text(aes(y = avg_risk_index, label = round(avg_risk_index, 2)), vjust = -0.5) +  # Add labels for risk index
  geom_text(aes(y = avg_collision_index, label = round(avg_collision_index, 2)), vjust = 1.5, color = "black") +  # Add labels for collision index
  geom_line(aes(y = avg_theft_index * 10), color = "green", size = 1, linetype = "dashed") +  # Theft index line (scaled by 100)
  geom_point(aes(y = avg_theft_index * 10), color = "green", size = 2) +  # Theft index points
  labs(
    
    x = "Time of Day",
    y = "Average Risk Index"
  ) +
  theme_minimal()





```

@fig-risk-index-timeofday illustrates the temporal variations in the overall Risk Index, divided into four time-of-day segments: Early Morning, Morning, Afternoon, and Evening. Collision risk illustrates a clear temporal pattern, with peaks during commuting hours—specifically in the Morning (7–9 AM) and Evening (5–7 PM), corresponding to periods of high traffic density. This indicates that collision risk is closely tied to traffic patterns, greater caution should be imposed during these periods to reduce the likelihood of collisions and enhance overall road safety. In contrast, theft risk remains relatively stable across all time bins, with no significant fluctuations. For better visualization, theft risk values have been scaled by a factor of 10, highlighting its consistently smaller contribution to the overall Risk Index.

The highest overall Risk Index is observed in the Morning bin, driven by elevated collision risk during this time. Afternoon and Evening bins show slightly lower overall Risk Index values, reflecting moderate variations in collision risk. The Early Morning bin has the lowest Risk Index, corresponding to minimal traffic activity and theft incidents.

### Time Series Analysis

This time series analysis explores how the Risk Index evolves over time, offering a long-term view across the years and a more focused examination of a specific year. By visualizing these temporal trends, we can reveal potential seasonal effects, fluctuations, and patterns that might not be immediately apparent in a snapshot of data. The following section presents the trends in the Risk Index over both the full timespan (2006-2021) and the specific year 2020.

#### Longterm

```{r}
#| label: fig-risk-index-timeseries-longterm
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "Long-Term Temporal Trends in Risk Index (Mid-2016 to Mid-2024) with Rolling Average"
#| fig-pos: H
#| fig-width: 8
#| fig-height: 3.5

# Load necessary libraries
library(tidyverse)
library(lubridate)
library(here)

# Load the cleaned traffic data
cleaned_traffic_data <- read_csv(here("data", "02-analysis_data", "cleaned_traffic_data.csv"))

# Load the final risk index if not already in `cleaned_traffic_data`
if (!"risk_index" %in% colnames(cleaned_traffic_data)) {
  final_risk_data <- read_csv(here("data", "02-analysis_data", "final_risk_index.csv"))
  cleaned_traffic_data <- cleaned_traffic_data %>%
    left_join(final_risk_data, by = "id")
}

# Convert `date` to Date format if not already
cleaned_traffic_data <- cleaned_traffic_data %>%
  mutate(date = as.Date(report_date))

# Aggregate data by date to calculate the average Risk Index
risk_trends <- cleaned_traffic_data %>%
  group_by(date) %>%
  summarize(avg_risk_index = mean(risk_index, na.rm = TRUE))

# Create a 6-month rolling average for clearer trend
risk_trends <- risk_trends %>%
  arrange(date) %>%
  mutate(rolling_avg = zoo::rollmean(avg_risk_index, 6, fill = NA, align = "center"))

# Create the time series plot for the entire period
ggplot(risk_trends, aes(x = date, y = avg_risk_index)) +
  geom_line(color = "#967145", size = 1, alpha = 0.7) +
  geom_line(aes(x = date, y = rolling_avg), color = "grey", size = 1, linetype = "dashed") +
  labs(
    
    x = "Year",
    y = "Average Risk Index"
  ) +
  scale_x_date(
    date_breaks = "2 years", 
    date_labels = "%Y"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12)
  )


```

@fig-risk-index-timeseries-longterm illustrates the long-term temporal trends in the Average Risk Index, measured daily and visualized from mid 2006 to mid 2023. The solid line represents the daily Average Risk Index, while the grey dashed line shows a six-month rolling average, providing a smoothed representation of the underlying trends.

The daily Average Risk Index illustrates considerable variability, reflecting fluctuations in risk factors such as collision and theft incidents over time. These short-term variations may be influenced by factors like weather conditions, traffic density, or seasonal changes. In contrast, the rolling average highlights more stable, long-term patterns, suggesting relatively stable long-term trends in the Risk Index, with no sudden increases or decreases over the years. However, several periodic dips and peaks in late 2016 and mid 2018 underscore the importance of addressing short-term change in risk to enhance overall safety. 

#### Covid Period

```{r}
#| label: fig-risk-index-timeseries-year
#| echo: false
#| warning: false
#| message: false
#| fig-cap: "Risk Index Variations in 2020 during Covid-19"
#| fig-pos: H
#| fig-width: 8.5
#| fig-height: 3.5

# Filter data for a specific year (e.g., 2020)
risk_trends_2020 <- cleaned_traffic_data %>%
  filter(year(date) == 2020) %>%
  group_by(date) %>%
  summarize(avg_risk_index = mean(risk_index, na.rm = TRUE))

risk_trends_2020 <- risk_trends_2020 %>%
  mutate(month = month(date, label = TRUE))

ggplot(risk_trends_2020, aes(x = date, y = avg_risk_index)) +
  geom_line(color = "#66471d", size = 0.8) +
  facet_wrap(~month, scales = "free_x") +  # Facet by month
  labs(
    x = "Month",
    y = "Average Risk Index"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
    axis.title = element_text(size = 12)
  )

```

@fig-risk-index-timeseries-year presents a detailed, month-by-month breakdown of the Risk Index for the year 2020. The graph highlights variations in risk levels across months, which may correspond to factors such as weather conditions, holidays, or other contextual events. For instance, dips in early September and November could relfect changes in traffic volume, seasonal behaviors, or shifts in theft or collision dynamics approaching the end of the year.

The year 2020 coincides with the beginning of the COVID-19 pandemic, which had a profound impact on urban mobility patterns. Lockdowns, social distancing measures, and reduced economic activities likely led to significant decreases in traffic volumes and changes in behavior related to motor vehicle usage [@buehler2021covid]. However, the Risk Index remains relatively consistent throughout the year, with only minor fluctuations across months. This relative stability may suggest that while pandemic-related restrictions likely influence traffic and mobility patterns, these changes did not significantly impact the overall Risk Index for the year. The consistent trends could reflect a balance between reductions in traffic collisions due to decreased activity during lockdown periods and a stable baseline for theft and other risk factors. 

## Conditions of Danger: Environmental Drivers of Risk

This section examines how factors such as road surface conditions, lighting conditions, and traffic control types contribute to changes in the Risk Index. Categorizing the data based on these factors reveals specific conditions under which the likelihood of collisions or theft increases. 

```{r}
#| label: fig-risk-index-lighting-conditions
#| fig-cap: "Risk Index by Lighting Conditions"
#| fig-subcap: ["Low Light (Dark & Artificial)", "Dawn and Artificial Light", "Bright Daylight and Artificial Light", "Other Lighting Conditions"]
#| echo: false
#| warning: false
#| message: false
#| layout-ncol: 2
#| layout-nrow: 2

# Load necessary libraries
library(ggplot2)
library(dplyr)

# Load the data
final_risk_data <- read_csv(here("data", "02-analysis_data", "final_risk_index.csv"))

cleaned_traffic_data <- read_csv(here("data", "02-analysis_data", "cleaned_traffic_data.csv"))

collision_risk_scores <- read_csv(here("data", "02-analysis_data", "collision_risk_scores.csv"))

# Convert 'id' to character in both datasets if necessary
final_risk_data$id <- as.character(final_risk_data$id)
cleaned_traffic_data$id <- as.character(cleaned_traffic_data$id)
collision_risk_scores$id <- as.character(collision_risk_scores$id)

# Merge the final risk index with the traffic data based on 'id'
merged_data <- left_join(final_risk_data, cleaned_traffic_data, by = "id")

# Merge the collision risk scores into the merged data
merged_data <- left_join(merged_data, collision_risk_scores, by = "id")

# Preprocess lighting conditions: Group 'NA' as 'Other' and create lighting condition categories for the full dataset
merged_data$lighting_conditions <- as.character(merged_data$lighting_conditions)  # Ensure it's a character vector

# Convert "NA" (actual value in the data) to "Other"
merged_data$lighting_conditions[merged_data$lighting_conditions == "NA"] <- "Other"

# Group lighting conditions into four categories, including "Other"
merged_data$lighting_condition_group <- case_when(
  merged_data$lighting_conditions %in% c("Dark", "Dark, Artificial") ~ "Low Light (Dark & Artificial)",
  merged_data$lighting_conditions %in% c("Dawn", "Dawn, Artificial") ~ "Dawn and Artificial Light",
  merged_data$lighting_conditions %in% c("Daylight", "Daylight, Artificial") ~ "Bright Daylight and Artificial Light",
  merged_data$lighting_conditions == "Other" ~ "Other Lighting Conditions"
)

# First Plot: Low Light (Dark & Artificial)
plot_dark <- ggplot(merged_data %>% filter(lighting_condition_group == "Low Light (Dark & Artificial)"), aes(x = risk_index, fill = lighting_condition_group)) +
  geom_density(alpha = 0.7) +
  scale_fill_manual(values = c("Low Light (Dark & Artificial)" = "#54350a")) +  # Custom color
  labs(x = "Risk Index", y = "Density") +
  theme_minimal() +
  theme(legend.position = "none")

# Second Plot: Dawn and Artificial Light
plot_dawn <- ggplot(merged_data %>% filter(lighting_condition_group == "Dawn and Artificial Light"), aes(x = risk_index, fill = lighting_condition_group)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(values = c("Dawn and Artificial Light" = "#54350a")) +  # Custom color
  labs(x = "Risk Index", y = "Density") +
  theme_minimal() +
  theme(legend.position = "none")

# Third Plot: Bright Daylight and Artificial Light
plot_daylight <- ggplot(merged_data %>% filter(lighting_condition_group == "Bright Daylight and Artificial Light"), aes(x = risk_index, fill = lighting_condition_group)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(values = c("Bright Daylight and Artificial Light" = "#54350a")) +  # Custom color
  labs(x = "Risk Index", y = "Density") +
  theme_minimal() +
  theme(legend.position = "none")

# Fourth Plot: Other Lighting Conditions
plot_other <- ggplot(merged_data %>% filter(lighting_condition_group == "Other Lighting Conditions"), aes(x = risk_index, fill = lighting_condition_group)) +
  geom_density(alpha = 0.6) +
  scale_fill_manual(values = c("Other Lighting Conditions" = "#54350a")) +  # Custom color
  labs(x = "Risk Index", y = "Density") +
  theme_minimal() +
  theme(legend.position = "none")

# Display the four plots side by side
plot_dark
plot_dawn
plot_daylight
plot_other

```

@fig-risk-index-lighting-conditions displays the distribution of the Risk Index across various lighting conditions. The data is broken down into four main lighting categories: Low Light (Dark & Artificial), Dawn and Artificial Light, Bright Daylight and Artificial Light, and Other Lighting Conditions.

@fig-risk-index-lighting-conditions-1 highlights that collision risks are higher under poor visibility, with a concentration of Risk Index values in the moderate-to-high range. These findings indicate that insufficient natural light, coupled with artificial lighting, may contribute to a heightened likelihood of incidents.

@fig-risk-index-lighting-conditions-2 reflects a mixed risk profile, with the density curve showing a broader spread across the Risk Index. While risk levels are slightly lower compared to low-light conditions, there is still a noticeable presence of moderate-risk incidents, likely influenced by transitioning visibility during dawn hours.

@fig-risk-index-lighting-conditions-3 reveals a more concentrated distribution of lower Risk Index values. This suggests that enhanced visibility and predictable traffic patterns during daylight hours contribute to reduced motorbike risks.

@fig-risk-index-lighting-conditions-4 captures a unique distribution, with a small number of outlier cases showing a less consistent pattern. These include conditions not explicitly defined by the primary categories or instances where lighting data is unavailable. The density curve indicates relatively stable, moderate-risk levels, likely driven by the diversity of conditions represented in this group.


## Mapping the Risk: Neighborhood-Level Insights

### Neighborhood Risk Distribution

```{r}
#| label: fig-his_collosion_risk
#| fig-cap: "Neighborhoods grouped by average collision probabilities into High, Medium, and Low risk categories."
#| echo: false
#| warning: false
#| message: false
#| fig-width: 7
#| fig-height: 3.5
#| 

# Load necessary libraries
library(tidyverse)
library(hrbrthemes)

# Load the dataset
data <- read.csv(here("data", "02-analysis_data", "collision_risk_scores.csv"))

# Take the average for duplicate neighborhoods
data <- data %>%
  group_by(hood_158) %>%
  summarise(collision_probability = mean(collision_probability, na.rm = TRUE)) %>%
  ungroup()

# Create groups: High, Medium, Low
data <- data %>%
  mutate(
    risk_group = case_when(
      collision_probability >= 0.8 ~ "High",
      collision_probability >= 0.6 ~ "Medium",
      TRUE ~ "Low"
    )
  )

# Adjusted theme to avoid font issues
ggplot(data, aes(x = collision_probability, color = risk_group, fill = risk_group)) +
  geom_histogram(alpha = 0.8, binwidth = 0.05) +
  scale_fill_manual(values = c("High" = "#54350a", "Medium" = "#2e3f78", "Low" = "#d1b33d")) +
  scale_color_manual(values = c("High" = "#54350a", "Medium" = "#2e3f78", "Low" = "#d1b33d")) +
  theme_minimal() +
  theme(
    legend.position = "right",
    panel.spacing = unit(0.1, "lines"),
    strip.text.x = element_text(size = 8)
  ) +
  xlab("Collision Probability") +
  ylab("Number of Neighborhoods") +
  labs(
    fill = "Risk Group",
    color = "Risk Group"
  ) +
  facet_wrap(~risk_group)


```

@fig-his_collosion_risk presents the distribution of Toronto neighborhoods based on their average collision probabilities, categorized into three risk levels: High, Medium, and Low. The High-risk category mainly includes neighborhoods with collision probabilities between 0.8 and 1.0, indicating a concentration of areas with increasing risk. The Medium-risk category includes neighborhoods with probabilities between 0.6 and 0.8, reflecting a moderate level of collision likelihood. The Low-risk category consists of neighborhoods with probabilities below 0.6, suggesting a lower collision risk in these areas. This distribution underscores the uneven spread of collision risks across Toronto neighborhoods, providing valuable insights into spatial patterns. It highlights the potential for geographically targeted interventions, such as implementing road safety measures or infrastructure improvements in neighborhoods with higher collision probabilities to address localized risks effectively.

### Maps

```{r}
#| label: fig-collision_map
#| fig-cap: "Neighborhood Collision Points in Toronto Highlighting High Collision Risk Areas"
#| echo: false
#| warning: false
#| message: false
#| fig-width: 8
#| fig-height: 5

# Load necessary libraries
library(sf)
library(ggplot2)
library(osmdata)
library(dplyr)

# Load the GeoJSON file
collision_data <- st_read(here("data", "02-analysis_data", "collision.geojson"), quiet = TRUE)


# Add a column to classify top 15 neighborhoods
top_15_hoods <- c(173, 88, 29, 61, 89, 84, 153, 53, 79, 157, 150, 12, 108, 143, 98)
collision_data <- collision_data %>%
  mutate(
  is_top_15 = ifelse(as.numeric(HOOD_158) %in% top_15_hoods, "High Collision Risk Neighborhoods", "Others")
)

# Get a basemap of Toronto from OpenStreetMap
toronto_bbox <- c(-79.6393, 43.5810, -79.1151, 43.8555)  # Toronto bounding box
toronto_map <- opq(bbox = toronto_bbox) %>%
  add_osm_feature(key = "landuse") %>%
  osmdata_sf()

# Verify CRS and transform if needed
collision_data <- st_transform(collision_data, crs = 4326)

# Update basemap query
toronto_map <- opq(bbox = toronto_bbox) %>%
  add_osm_feature(key = "landuse", value = "residential") %>%
  osmdata_sf()

# Create the plot
ggplot() +
  # Add basemap
  geom_sf(data = toronto_map$osm_polygons, fill = "gray90", color = "gray70") +
  # Add collision points with classification
  geom_sf(data = collision_data, aes(color = is_top_15), size = 0.5, alpha = 0.6) +
  scale_color_manual(values = c("High Collision Risk Neighborhoods" = "red", "Others" = "yellow")) +
  labs(
    x = "Longitude",
    y = "Latitude",
    color = "Neighborhood Type",
    title = "Neighborhood Collision Points in Toronto"
  ) +
  theme_minimal()

```
 
@fig-collision_map illustrates the distribution of collision points across Toronto, emphasizing neighborhoods categorized as "High Collision Risk" in red and other areas in yellow. The spatial extent spans latitudes from approximately 43.55°N to 43.85°N and longitudes from -79.6°W to -79.1°W, covering most of Toronto's urban landscape.

The high collision risk neighborhoods are clustered primarily in specific areas, as denoted by the red points. These regions often correspond to densely populated or high-traffic zones, where the likelihood of traffic collisions is significantly increased. In contrast, the yellow points represent areas where collisions have taken place but with lower collision risks. While these points are more dispersed across the map, they show a notable concentration in downtown Toronto. This clustering in the downtown area suggests that even neighborhoods with moderate or lower collision risks can experience a high frequency of incidents due to the dense urban environment, heavy traffic flows, and increased walkers and cyclist activity typical of central urban areas. This observation highlights the importance of comprehensive urban traffic management strategies across risk levels to improve safety in both high- and low-risk neighborhoods.

This map provides a critical spatial perspective, highlighting the geographic disparities in traffic collision risks within Toronto. It underscores the need for targeted safety interventions, such as traffic calming measures and enhanced infrastructure, in the high-risk neighborhoods. The visualization also serves as a tool for urban planners and policymakers to identify and prioritize areas where safety improvements could significantly reduce the frequency and severity of traffic collisions, fostering a safer urban environment.

# Discussion {#sec-discussion}

## Temporal Risk Patterns and Behavioral Recommendations

Focus: This section can interpret the temporal trends in the Risk Index and their implications for motorbike owners and policymakers. For instance, if risks peak at certain hours or days, actionable recommendations can be made for owners to avoid high-risk times or take precautions.

Key Points: Discuss high-risk times of day or days of the week for both theft and collisions. Recommendations for motorbike owners to reduce risk exposure, such as avoiding specific time periods or enhancing security measures during peak theft hours. Potential scheduling adjustments for law enforcement patrols to align with high-risk periods..

## Environmental and Situational Influences on Risk

Focus: This section can examine how road, lighting, and traffic conditions contribute to the Risk Index, linking these findings to actionable changes in infrastructure or urban planning.

Key Points: Discuss the significant environmental predictors of risk, such as poor road surface conditions or inadequate lighting. Recommend urban planning measures, such as improved road maintenance or installation of streetlights, to mitigate risks. Highlight how different environmental factors interact to amplify risks, suggesting multi-faceted approaches to improve safety.

## Policy Implications of Spatial Risk Disparities

Focus: This section can discuss the significant disparities in the Risk Index across neighborhoods. Highlight how certain areas are disproportionately affected by theft or collisions and the potential socioeconomic or infrastructure factors contributing to these risks.

Key Points: Prioritizing high-risk neighborhoods for targeted interventions, such as improved street lighting or traffic control measures. Suggestions for law enforcement strategies to reduce theft in hotspots. Need for localized awareness campaigns in high-risk areas.

## Limitations

## Future Research

Future Work1: Explore how temporal risk patterns change with seasons or special events (e.g., holidays, festivals) to refine recommendations further.

Future Work2: Develop predictive models integrating weather or real-time traffic data to dynamically assess and communicate motorbike risks.

Future Work3: Investigate the correlation between neighborhood-level Risk Index values and broader social or economic indicators, such as income levels or population density. \newpage

\appendix

# Appendix {.unnumbered}

# Additional Data Details {#sec-data_details}

## Data Cleaning

# Model details {#sec-model-details}

## Posterior predictive check

In @fig-ppcheckandposteriorvsprior-1 we implement a posterior predictive check. This shows...

In @fig-ppcheckandposteriorvsprior-2 we compare the posterior with the prior. This shows...

```{r}

```

## Diagnostics

@fig-stanareyouokay-1 is a trace plot. It shows... This suggests...

@fig-stanareyouokay-2 is a Rhat plot. It shows... This suggests...

```{r}

```

\newpage

# Idealized Methodology for a Survey on Motor Risk {#sec-survey}

## Survey Overview

This survey aims to assess factors contributing to motorbike risks, including theft and collisions, by gathering data from motorbike owners and riders. The survey will explore demographic characteristics, riding behavior, motorbike usage patterns, and perceptions of environmental and situational risks.

## Sampling Approach

The survey will use a stratified random sampling method to ensure diverse representation across:

-   Geographic regions (urban, suburban, rural areas).
-   Demographic groups (age, gender, income, and education levels).
-   Riding experience (novices, intermediate, and experienced riders).

The target population includes licensed motorbike riders and owners. A sample size of approximately 1,000 respondents is proposed to ensure statistical validity across strata.

## Survey structure

The survey will consist of five main sections:

-   Demographics: Basic information on respondents (e.g., age, gender, income, education, geographic location).

-   Riding Behavior: Frequency, duration, and purpose of motorbike usage.

-   Risk Awareness and Perception: Personal experiences with collisions or theft and perceptions of environmental risks.

-   Situational Factors: Details of riding conditions such as time of day, weather, road surface, and lighting.

-   Preventive Measures: Actions taken by riders to mitigate theft or collision risks (e.g., use of locks, helmets, or avoiding high-risk areas).

### Question Types

-   Closed-ended questions: For quantitative data (e.g., multiple choice, Likert scales, ranking).

-   Open-ended questions: To capture nuanced insights and personal experiences.

-   Matrix questions: To evaluate attitudes across multiple dimensions efficiently.

### Question List

Here are examples of survey questions:

Demographics: What is your age group? (e.g., 18–24, 25–34, etc.) What is your highest level of education completed?

Riding Behavior: How often do you ride your motorbike? (Daily, Weekly, Monthly, Rarely) For what purposes do you primarily use your motorbike? (Commuting, Recreation, Delivery/Work, Other)

Risk Awareness and Perception: On a scale of 1–5, how would you rate the theft risk in your neighborhood? Have you experienced a motorbike theft or collision in the past year? (Yes/No)

Situational Factors: What time of day do you usually ride? (Morning, Afternoon, Evening, Night) In what weather conditions do you typically ride? (Clear, Rainy, Snowy)

Preventive Measures: What measures do you take to secure your motorbike against theft? (Select all that apply: Lock, Alarm, GPS Tracker, Parking in Secure Locations) Do you avoid specific times or areas due to perceived collision risks? (Yes/No)

## Recruitment Strategy

Participants will be recruited through a combination of online and offline channels:

Online platforms: Motorbike owner forums, social media groups, and email lists of motorbike organizations.

Offline channels: Flyers at motorbike dealerships, repair shops, and riding schools. Incentives such as small gift cards or entry into a raffle may be provided to encourage participation.

## Linkage to Literature

The survey design is informed by prior studies on motor vehicle risk perception, road safety, and crime prevention. Key references include:

Research on environmental and situational predictors of road accidents. Studies on the effectiveness of theft prevention measures. Literature on sampling methods and survey design for risk assessment.

# References
